<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clinic Hero | Puericultura v1.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .glass-card { background: white; border-radius: 24px; border: 1px solid #f1f5f9; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.02); }
        .input-ped { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; font-weight: bold; color: #2563eb; outline: none; }
        .input-ped:focus { border-color: #2563eb; background: white; }
    </style>
</head>
<body class="bg-[#F8FAFC] h-screen flex flex-col font-sans text-slate-900 overflow-hidden">

    <header class="h-16 bg-white border-b px-8 flex items-center justify-between z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-xl font-black shadow-lg shadow-blue-200">CH</div>
            <h1 class="font-bold text-slate-700 tracking-tight">CLINIC HERO <span id="label-role" class="text-blue-500 text-[10px] ml-2 px-2 py-0.5 bg-blue-50 rounded-full uppercase">Pediatria Inteligente</span></h1>
        </div>
        <button onclick="location.reload()" class="text-slate-300 hover:text-red-500 transition"><i data-lucide="power"></i></button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside id="sidebar" class="hidden w-64 bg-white border-r p-6 flex flex-col gap-2 shrink-0">
            </aside>

        <main id="main-view" class="flex-1 p-8 overflow-y-auto">
            
            <div id="portal-select" class="max-w-md mx-auto mt-20 text-center bg-white p-12 rounded-[40px] shadow-2xl shadow-slate-200 border border-slate-50">
                <h2 class="text-2xl font-black mb-10 text-slate-800 tracking-tight">Qual portal deseja acessar?</h2>
                <div class="space-y-4">
                    <button onclick="entrarApp('medico')" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold hover:bg-slate-800 transition active:scale-95 shadow-xl flex items-center justify-center gap-3">
                        <i data-lucide="stethoscope"></i> Portal Médico
                    </button>
                    <button onclick="entrarApp('secretaria')" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold hover:bg-blue-700 transition active:scale-95 shadow-xl shadow-blue-100 flex items-center justify-center gap-3">
                        <i data-lucide="users"></i> Portal Recepção
                    </button>
                </div>
                <p class="mt-8 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Clinic Hero v1.9 - 2026</p>
            </div>

        </main>
    </div>

    <script>
        const SB_URL = "https://ptcntqkmeypufwjrknyt.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y250cWttZXlwdWZ3anJrbnl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1Mzg3NjAsImV4cCI6MjA4MzExNDc2MH0.GPK2aNE9LYBBLVzFq7SVldhE0rzkXI3teYfwwh7TMtk";
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let currentUserRole = '';

        function entrarApp(role) {
            currentUserRole = role;
            document.getElementById('portal-select').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('label-role').innerText = role === 'medico' ? 'Doutor' : 'Recepção';
            
            renderSidebar();
            role === 'medico' ? renderMedicoHome() : renderSecretariaHome();
            lucide.createIcons();
        }

        function renderSidebar() {
            const side = document.getElementById('sidebar');
            if(currentUserRole === 'medico') {
                side.innerHTML = `
                    <button onclick="renderMedicoHome()" class="flex items-center gap-3 p-4 w-full rounded-2xl bg-blue-50 text-blue-600 font-bold mb-2"><i data-lucide="list"></i> Atendimentos</button>
                    <button class="flex items-center gap-3 p-4 w-full text-slate-400 font-medium"><i data-lucide="calendar"></i> Minha Agenda</button>
                `;
            } else {
                side.innerHTML = `
                    <button onclick="renderSecretariaHome()" class="flex items-center gap-3 p-4 w-full rounded-2xl bg-blue-600 text-white font-bold mb-2 shadow-lg shadow-blue-100"><i data-lucide="plus-circle"></i> Novo Cadastro</button>
                    <button onclick="listarTodosPacientes()" class="flex items-center gap-3 p-4 w-full text-slate-400 font-medium hover:bg-slate-50 rounded-xl transition"><i data-lucide="users"></i> Todos Pacientes</button>
                `;
            }
        }

        // --- LÓGICA DE ALERTA DE ATRASO (SUA REGRA) ---
        function getStatusAlerta(meses, diasDesdeUltima) {
            if (meses <= 11) return diasDesdeUltima > 30 ? 'ATRASADO' : 'EM DIA';
            if (meses >= 12 && meses <= 22) return diasDesdeUltima > 90 ? 'ATRASADO' : 'EM DIA';
            if (meses >= 23 && meses <= 46) return diasDesdeUltima > 180 ? 'ATRASADO' : 'EM DIA';
            return diasDesdeUltima > 365 ? 'ATRASADO' : 'EM DIA';
        }

        // --- VIEWS ---
        async function renderMedicoHome() {
            const main = document.getElementById('main-view');
            main.innerHTML = `<p class="text-blue-600 font-bold animate-pulse">Carregando fila de pacientes...</p>`;
            
            const { data } = await supabase.from('pacientes').select('*').order('criado_em', { ascending: false });
            
            main.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-3xl font-black mb-8 text-slate-800">Fila de Atendimento</h2>
                    <div class="grid gap-4">
                        ${data.map(p => `
                            <div onclick="abrirProntuario('${p.id}', '${p.nome}', '${p.data_nascimento}')" class="bg-white p-6 rounded-[24px] border border-slate-100 hover:border-blue-500 transition cursor-pointer flex justify-between items-center group shadow-sm">
                                <div>
                                    <h4 class="font-bold text-lg text-slate-800">${p.nome}</h4>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Nasc: ${p.data_nascimento || '---'}</p>
                                </div>
                                <span class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black">ATENDER →</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function abrirProntuario(id, nome, nascimento) {
            const main = document.getElementById('main-view');
            // Cálculo básico de idade (meses)
            const nasc = new Date(nascimento);
            const hoje = new Date();
            const mesesIdade = (hoje.getFullYear() - nasc.getFullYear()) * 12 + (hoje.getMonth() - nasc.getMonth());

            main.innerHTML = `
                <div class="max-w-5xl mx-auto fade-in">
                    <div class="flex justify-between items-end mb-10">
                        <div>
                            <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter">Idade Atual: ${mesesIdade} meses</span>
                            <h2 class="text-4xl font-black text-slate-800 mt-2">${nome}</h2>
                        </div>
                        <button onclick="renderMedicoHome()" class="text-slate-400 font-bold hover:text-blue-600">Voltar para Fila</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-[30px] border shadow-sm grid grid-cols-3 gap-6">
                                <div class="text-center">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Peso (kg)</p>
                                    <input id="p-peso" type="number" step="0.001" class="input-ped w-full text-center">
                                </div>
                                <div class="text-center">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Altura (cm)</p>
                                    <input id="p-alt" type="number" class="input-ped w-full text-center">
                                </div>
                                <div class="text-center">
                                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">P. Cefálico</p>
                                    <input id="p-pc" type="number" class="input-ped w-full text-center">
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-[30px] border shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="edit-3" class="w-4 h-4 text-blue-500"></i> Evolução Clínica</h4>
                                <textarea id="p-evo" class="w-full h-80 bg-slate-50 rounded-2xl p-6 outline-none text-slate-600 border-none resize-none" placeholder="Anote aqui a evolução pediátrica..."></textarea>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-slate-900 text-white p-8 rounded-[40px] shadow-2xl">
                                <p class="text-[10px] font-bold opacity-40 uppercase tracking-widest mb-1">Ação de Atendimento</p>
                                <div class="text-lg font-bold text-blue-400 mb-6 italic">Geração de Histórico...</div>
                                <button onclick="finalizarConsulta('${id}', ${mesesIdade})" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-5 rounded-2xl font-black transition shadow-lg shadow-blue-900/40">FINALIZAR CONSULTA</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        async function finalizarConsulta(paciente_id, idadeMeses) {
            const peso = document.getElementById('p-peso').value;
            const altura = document.getElementById('p-alt').value;
            const pc = document.getElementById('p-pc').value;
            const evo = document.getElementById('p-evo').value;

            const { error } = await supabase.from('consultas').insert([{
                paciente_id, peso, altura, perimetro_cefalico: pc, evolucao: evo, idade_na_consulta: idadeMeses + " meses"
            }]);

            if (error) alert(error.message);
            else { alert("Consulta salva no histórico!"); renderMedicoHome(); }
        }

        function renderSecretariaHome() {
            document.getElementById('main-view').innerHTML = `
                <div class="max-w-md mx-auto bg-white p-10 rounded-[40px] shadow-sm border border-slate-100 mt-10">
                    <h2 class="text-2xl font-black mb-8">Cadastro de Paciente</h2>
                    <div class="space-y-4">
                        <input id="f-nome" placeholder="Nome da Criança" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold">
                        <input id="f-nasc" type="date" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-500">
                        <button onclick="salvarPaciente()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-lg shadow-blue-100 mt-4">CADASTRAR</button>
                    </div>
                </div>
            `;
        }

        async function salvarPaciente() {
            const nome = document.getElementById('f-nome').value;
            const nasc = document.getElementById('f-nasc').value;
            const { error } = await supabase.from('pacientes').insert([{ nome, data_nascimento: nasc }]);
            if (error) alert(error.message);
            else { alert("Paciente cadastrado!"); renderSecretariaHome(); }
        }

        async function listarTodosPacientes() {
            const main = document.getElementById('main-view');
            const { data } = await supabase.from('pacientes').select('*');
            main.innerHTML = `<h2 class="text-2xl font-black mb-6">Todos Pacientes</h2>` + 
                data.map(p => `<div class="p-4 bg-white border rounded-2xl mb-2 font-bold">${p.nome}</div>`).join('');
        }

        // Auto-inicializa ícones
        lucide.createIcons();
    </script>
</body>
</html>
