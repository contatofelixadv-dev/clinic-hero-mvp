<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clinic Hero | v2.4 Corrigido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .pep-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 10px; }
        .input-ped { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 12px; margin-bottom: 12px; outline: none; }
        .input-ped:focus { border-color: #2563eb; background: #eff6ff; }
        .btn-menu { width: 100%; text-align: left; padding: 12px; border-radius: 12px; margin-bottom: 8px; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .btn-menu:hover { background-color: #f1f5f9; }
        .btn-active { background-color: #eff6ff; color: #2563eb; }
    </style>
</head>
<body class="bg-[#F8FAFC] h-screen font-sans text-slate-900 overflow-hidden">

    <div id="login-area" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="bg-white p-10 rounded-[40px] w-96 text-center shadow-2xl">
            <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white font-black text-2xl mx-auto mb-6 shadow-lg">CH</div>
            <h1 class="text-2xl font-black mb-8 text-slate-800">Clinic Hero v2.4</h1>
            
            <button onclick="entrar('medico')" class="w-full bg-slate-800 text-white py-5 rounded-2xl font-bold mb-4 hover:bg-slate-700 shadow-xl transition active:scale-95">
                ACESSO MÉDICO
            </button>
            
            <button onclick="entrar('secretaria')" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-200 transition active:scale-95">
                ACESSO SECRETARIA
            </button>
        </div>
    </div>

    <div id="app-area" class="hidden fixed inset-0 flex-col h-full bg-[#F8FAFC]">
        <header class="h-16 bg-white border-b px-8 flex items-center justify-between shadow-sm shrink-0 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg font-black">CH</div>
                <div class="font-bold text-slate-700 uppercase text-sm">Clinic Hero | <span id="user-badge" class="text-blue-500">...</span></div>
            </div>
            <button onclick="location.reload()" class="text-xs text-red-500 font-bold border border-red-100 px-4 py-2 rounded-full hover:bg-red-50 transition">SAIR</button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="w-64 bg-white border-r p-6 flex flex-col shrink-0 z-10">
                </aside>
            <main id="content" class="flex-1 p-8 overflow-y-auto">
                </main>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE ---
        const SB_URL = "https://ptcntqkmeypufwjrknyt.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y250cWttZXlwdWZ3anJrbnl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1Mzg3NjAsImV4cCI6MjA4MzExNDc2MH0.GPK2aNE9LYBBLVzFq7SVldhE0rzkXI3teYfwwh7TMtk";
        
        let supabase = null;
        try {
            if(window.supabase) supabase = window.supabase.createClient(SB_URL, SB_KEY);
        } catch(e) { console.error("Erro biblioteca:", e); }

        // --- 2. NAVEGAÇÃO ---
        function entrar(perfil) {
            // Troca visual
            document.getElementById('login-area').style.display = 'none';
            document.getElementById('app-area').style.display = 'flex';
            document.getElementById('user-badge').innerText = perfil.toUpperCase();

            // Injeta o Menu
            const side = document.getElementById('sidebar');
            if(perfil === 'medico') {
                side.innerHTML = `
                    <button onclick="telaFila()" class="btn-menu btn-active"><i data-lucide="list"></i> Fila de Espera</button>
                    <button class="btn-menu text-slate-400"><i data-lucide="calendar"></i> Agenda</button>
                `;
                telaFila(); // Carrega a tela inicial do médico
            } else {
                side.innerHTML = `
                    <button onclick="telaCadastro()" class="btn-menu btn-active"><i data-lucide="plus-circle"></i> Novo Cadastro</button>
                    <button onclick="telaLista()" class="btn-menu text-slate-500"><i data-lucide="users"></i> Ver Pacientes</button>
                `;
                telaCadastro(); // Carrega a tela inicial da secretaria
            }
            safeIcons();
        }

        // --- 3. TELAS ---
        function telaCadastro() {
            document.getElementById('content').innerHTML = `
                <div class="max-w-md mx-auto bg-white p-10 rounded-[30px] border border-slate-100 shadow-sm fade-in">
                    <h2 class="text-2xl font-black mb-6 text-slate-800">Novo Paciente</h2>
                    
                    <label class="text-xs font-bold text-slate-400 ml-1">NOME COMPLETO</label>
                    <input id="nome" type="text" class="input-ped" placeholder="Ex: Gabriel Félix">
                    
                    <label class="text-xs font-bold text-slate-400 ml-1">DATA DE NASCIMENTO</label>
                    <input id="nasc" type="date" class="input-ped">
                    
                    <button onclick="salvarPaciente()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mt-4 hover:bg-blue-700 transition shadow-lg shadow-blue-200">SALVAR NO BANCO</button>
                </div>
            `;
            safeIcons();
        }

        async function telaLista() {
            const main = document.getElementById('content');
            main.innerHTML = `<p class="animate-pulse text-blue-600 font-bold">Carregando lista...</p>`;
            
            if(!supabase) return main.innerHTML = "Erro: Banco desconectado.";

            const { data, error } = await supabase.from('pacientes').select('*').order('criado_em', {ascending: false});
            
            if(error) return main.innerHTML = "Erro: " + error.message;

            main.innerHTML = `<h2 class="text-2xl font-black mb-6">Todos os Pacientes</h2>` + 
                data.map(p => `
                    <div class="bg-white p-4 rounded-xl border border-slate-100 mb-3 font-bold text-slate-700 shadow-sm flex justify-between">
                        <span>${p.nome}</span>
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">${p.data_nascimento || 'S/D'}</span>
                    </div>
                `).join('');
        }

        async function telaFila() {
            const main = document.getElementById('content');
            main.innerHTML = `<p class="animate-pulse text-blue-600 font-bold">Buscando fila...</p>`;
            
            if(!supabase) return main.innerHTML = "Erro: Banco desconectado.";

            const { data, error } = await supabase.from('pacientes').select('*').order('criado_em', {ascending: false});

            main.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-3xl font-black mb-8 text-slate-800">Fila Pediátrica</h2>
                    <div class="grid gap-4">
                        ${data.map(p => `
                            <div onclick="abrirProntuario('${p.id}', '${p.nome}', '${p.data_nascimento}')" class="bg-white p-6 rounded-[24px] border border-slate-100 hover:border-blue-500 transition cursor-pointer flex justify-between items-center group shadow-sm">
                                <div>
                                    <h4 class="font-bold text-lg text-slate-800">${p.nome}</h4>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Nasc: ${p.data_nascimento || '---'}</p>
                                </div>
                                <span class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black group-hover:bg-blue-600 group-hover:text-white transition">ATENDER →</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            safeIcons();
        }

        function abrirProntuario(id, nome, nascimento) {
            // Lógica de Idade
            let idadeLabel = "Idade não informada";
            let meses = 0;
            if(nascimento) {
                const d1 = new Date(nascimento);
                const d2 = new Date();
                meses = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
                if(d2.getDate() < d1.getDate()) meses--;
                idadeLabel = `${meses} MESES`;
            }

            document.getElementById('content').innerHTML = `
                <div class="max-w-5xl mx-auto fade-in">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">${idadeLabel}</span>
                            <h2 class="text-4xl font-black text-slate-800 mt-2">${nome}</h2>
                        </div>
                        <button onclick="telaFila()" class="text-slate-400 font-bold hover:text-blue-600">Voltar</button>
                    </div>

                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div class="bg-white p-4 rounded-2xl border text-center">
                            <label class="text-[10px] font-black text-slate-400 uppercase">PESO (KG)</label>
                            <input id="peso" type="number" step="0.001" class="w-full text-center text-xl font-bold text-blue-600 outline-none mt-2" placeholder="0.000">
                        </div>
                        <div class="bg-white p-4 rounded-2xl border text-center">
                            <label class="text-[10px] font-black text-slate-400 uppercase">ALTURA (CM)</label>
                            <input id="altura" type="number" class="w-full text-center text-xl font-bold text-blue-600 outline-none mt-2" placeholder="00">
                        </div>
                        <div class="bg-white p-4 rounded-2xl border text-center">
                            <label class="text-[10px] font-black text-slate-400 uppercase">P. CEFÁLICO</label>
                            <input id="pc" type="number" class="w-full text-center text-xl font-bold text-blue-600 outline-none mt-2" placeholder="00">
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-[30px] border shadow-sm mb-6">
                        <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2">Evolução Clínica</h4>
                        <textarea id="evolucao" class="w-full h-64 bg-slate-50 rounded-2xl p-4 outline-none text-slate-600 border-none resize-none" placeholder="Digite a evolução..."></textarea>
                    </div>

                    <button onclick="finalizar('${id}', '${idadeLabel}')" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black hover:bg-slate-800 transition shadow-xl">FINALIZAR CONSULTA</button>
                </div>
            `;
            safeIcons();
        }

        // --- 4. AÇÕES ---
        async function salvarPaciente() {
            const nome = document.getElementById('nome').value;
            const nasc = document.getElementById('nasc').value;
            
            if(!supabase) return alert("Erro de conexão");
            if(!nome) return alert("Preencha o nome");

            const { error } = await supabase.from('pacientes').insert([{ nome, data_nascimento: nasc }]);
            
            if(error) alert("Erro: " + error.message);
            else { alert("Salvo!"); telaCadastro(); }
        }

        async function finalizar(pid, idade) {
            const peso = document.getElementById('peso').value;
            const altura = document.getElementById('altura').value;
            const pc = document.getElementById('pc').value;
            const evo = document.getElementById('evolucao').value;

            const { error } = await supabase.from('consultas').insert([{
                paciente_id: pid, peso, altura, perimetro_cefalico: pc, evolucao: evo, idade_na_consulta: idade
            }]);

            if(error) alert("Erro: " + error.message);
            else { alert("Consulta salva!"); telaFila(); }
        }

        function safeIcons() {
            try { lucide.createIcons(); } catch(e) {}
        }
    </script>
</body>
</html>
