<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clinic Hero | v2.3 Blindado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .pep-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; padding: 20px; }
        .input-ped { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 10px; margin-bottom: 10px; }
        /* Garante que o App comece invis√≠vel */
        #app-area { display: none; } 
    </style>

    <script>
        function forcarEntrada(perfil) {
            // 1. Some com o Login
            document.getElementById('login-area').style.display = 'none';
            // 2. Mostra o App
            document.getElementById('app-area').style.display = 'flex';
            
            // 3. Configura a tela
            document.getElementById('user-badge').innerText = perfil === 'medico' ? 'DOUTOR' : 'SECRETARIA';
            
            // 4. Carrega o menu certo
            if(perfil === 'medico') {
                carregarMenuMedico();
                carregarTelaMedico(); // Tenta carregar dados, se falhar, mostra vazio
            } else {
                carregarMenuSecretaria();
                carregarTelaCadastro();
            }
            
            // Tenta carregar √≠cones se a biblioteca tiver baixado
            try { lucide.createIcons(); } catch(e) {}
        }
    </script>
</head>
<body class="bg-slate-50 h-screen font-sans text-slate-900">

    <div id="login-area" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900">
        <div class="bg-white p-10 rounded-3xl w-96 text-center">
            <div class="text-4xl mb-6">üè•</div>
            <h1 class="text-2xl font-bold mb-8">Clinic Hero v2.3</h1>
            
            <button onclick="forcarEntrada('medico')" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold mb-4 hover:bg-slate-700 cursor-pointer">
                ACESSO M√âDICO
            </button>
            
            <button onclick="forcarEntrada('secretaria')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 cursor-pointer">
                ACESSO SECRETARIA
            </button>
            
            <p class="mt-4 text-xs text-slate-400">Clique para entrar (Modo Seguro)</p>
        </div>
    </div>

    <div id="app-area" class="fixed inset-0 flex flex-col h-full hidden">
        <header class="h-16 bg-white border-b px-6 flex items-center justify-between shadow-sm shrink-0">
            <div class="font-bold text-blue-600 flex items-center gap-2">CLINIC HERO <span id="user-badge" class="bg-blue-100 px-2 py-1 rounded text-xs">ONLINE</span></div>
            <button onclick="location.reload()" class="text-xs text-red-500 font-bold border px-3 py-1 rounded-full hover:bg-red-50">SAIR</button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="w-64 bg-white border-r p-4 flex flex-col gap-2 shrink-0">
                </aside>
            <main id="content" class="flex-1 p-8 overflow-y-auto">
                </main>
        </div>
    </div>

    <script>
        // -- MENUS --
        function carregarMenuMedico() {
            document.getElementById('sidebar').innerHTML = `
                <button onclick="carregarTelaMedico()" class="w-full text-left p-3 rounded-xl bg-blue-50 text-blue-600 font-bold mb-2">Fila de Atendimento</button>
                <button class="w-full text-left p-3 rounded-xl text-slate-400">Agenda</button>
            `;
        }
        function carregarMenuSecretaria() {
            document.getElementById('sidebar').innerHTML = `
                <button onclick="carregarTelaCadastro()" class="w-full text-left p-3 rounded-xl bg-blue-600 text-white font-bold mb-2">Novo Cadastro</button>
                <button onclick="carregarTelaLista()" class="w-full text-left p-3 rounded-xl hover:bg-slate-100 text-slate-500">Ver Pacientes</button>
            `;
        }

        // -- TELAS --
        function carregarTelaCadastro() {
            document.getElementById('content').innerHTML = `
                <div class="max-w-md mx-auto bg-white p-8 rounded-2xl border shadow-sm">
                    <h2 class="text-xl font-bold mb-6">Novo Paciente</h2>
                    <label class="block text-xs font-bold text-slate-400 mb-1">NOME COMPLETO</label>
                    <input id="nome" type="text" class="input-ped">
                    
                    <label class="block text-xs font-bold text-slate-400 mb-1">DATA NASCIMENTO</label>
                    <input id="nasc" type="date" class="input-ped">
                    
                    <button onclick="salvar()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-4">SALVAR NO BANCO</button>
                </div>
            `;
        }

        // -- BANCO DE DADOS (SUPABASE) --
        const SB_URL = "https://ptcntqkmeypufwjrknyt.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y250cWttZXlwdWZ3anJrbnl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1Mzg3NjAsImV4cCI6MjA4MzExNDc2MH0.GPK2aNE9LYBBLVzFq7SVldhE0rzkXI3teYfwwh7TMtk";
        
        // Conex√£o segura
        let supabase = null;
        try {
            if(window.supabase) supabase = window.supabase.createClient(SB_URL, SB_KEY);
        } catch(e) { console.error("Erro Supabase:", e); }

        async function salvar() {
            if(!supabase) return alert("Erro: Banco de dados desconectado (Verifique sua internet)");
            
            const nome = document.getElementById('nome').value;
            const nasc = document.getElementById('nasc').value;
            
            if(!nome) return alert("Digite o nome!");

            const { error } = await supabase.from('pacientes').insert([{ nome, data_nascimento: nasc }]);
            
            if(error) alert("Erro ao salvar: " + error.message);
            else { alert("Paciente cadastrado!"); carregarTelaCadastro(); }
        }

        async function carregarTelaLista() {
            const main = document.getElementById('content');
            main.innerHTML = "Carregando lista...";
            
            if(!supabase) return main.innerHTML = "Sem conex√£o com banco.";

            const { data, error } = await supabase.from('pacientes').select('*').order('criado_em', {ascending: false});
            
            main.innerHTML = `<h2 class="text-2xl font-bold mb-4">Lista de Pacientes</h2>` + 
                data.map(p => `<div class="p-3 bg-white border rounded-xl mb-2 font-bold">${p.nome}</div>`).join('');
        }

        async function carregarTelaMedico() {
            const main = document.getElementById('content');
            main.innerHTML = "Buscando pacientes...";
            
            if(!supabase) return main.innerHTML = "Sem conex√£o com banco.";

            const { data } = await supabase.from('pacientes').select('*').order('criado_em', {ascending: false});
            
            main.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Fila Pedi√°trica</h2>
                <div class="grid gap-4">
                    ${data.map(p => `
                        <div onclick="abrirProntuario('${p.id}', '${p.nome}', '${p.data_nascimento}')" class="bg-white p-4 rounded-xl border hover:border-blue-500 cursor-pointer flex justify-between items-center shadow-sm">
                            <div>
                                <div class="font-bold text-lg">${p.nome}</div>
                                <div class="text-xs text-slate-400 font-bold uppercase">Nasc: ${p.data_nascimento || '--'}</div>
                            </div>
                            <div class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold">ATENDER</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function abrirProntuario(id, nome, nascimento) {
            // L√≥gica de idade
            const d1 = new Date(nascimento);
            const d2 = new Date();
            let meses = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
            if(d2.getDate() < d1.getDate()) meses--;
            if(isNaN(meses)) meses = 0;

            document.getElementById('content').innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">IDADE: ${meses} MESES</span>
                            <h2 class="text-3xl font-bold mt-1">${nome}</h2>
                        </div>
                        <button onclick="carregarTelaMedico()" class="text-slate-400 font-bold">Voltar</button>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div><label class="text-xs font-bold text-slate-400">PESO (KG)</label><input id="p_peso" type="number" class="input-ped"></div>
                        <div><label class="text-xs font-bold text-slate-400">ALTURA (CM)</label><input id="p_alt" type="number" class="input-ped"></div>
                        <div><label class="text-xs font-bold text-slate-400">P. CEF√ÅLICO</label><input id="p_pc" type="number" class="input-ped"></div>
                    </div>

                    <label class="text-xs font-bold text-slate-400">EVOLU√á√ÉO CL√çNICA</label>
                    <textarea id="p_evo" class="w-full h-40 border rounded-xl p-4 mb-4 outline-none" placeholder="Escreva aqui..."></textarea>
                    
                    <button onclick="finalizar('${id}', '${meses} meses')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700">SALVAR CONSULTA</button>
                </div>
            `;
        }

        async function finalizar(pid, idade) {
            const peso = document.getElementById('p_peso').value;
            const altura = document.getElementById('p_alt').value;
            const pc = document.getElementById('p_pc').value;
            const evo = document.getElementById('p_evo').value;

            const { error } = await supabase.from('consultas').insert([{
                paciente_id: pid, peso, altura, perimetro_cefalico: pc, evolucao: evo, idade_na_consulta: idade
            }]);

            if(error) alert(error.message);
            else { alert("Consulta Salva!"); carregarTelaMedico(); }
        }
    </script>
</body>
</html>
