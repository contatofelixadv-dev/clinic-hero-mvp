<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Clinic Hero | Destravado v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .pep-card { background: white; border-radius: 24px; border: 1px solid #f1f5f9; padding: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.02); }
        .input-ped { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; text-align: center; font-weight: bold; color: #2563eb; outline: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F8FAFC] h-screen overflow-hidden flex flex-col font-sans text-slate-900">

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-[400px] text-center fade-in">
            <div class="bg-blue-600 w-16 h-16 rounded-2xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-6 shadow-lg shadow-blue-500/20">CH</div>
            <h1 class="text-2xl font-black mb-10 text-slate-800">Portal Clinic Hero</h1>
            <div class="space-y-4">
                <button onclick="entrar('medico')" class="w-full bg-slate-800 text-white py-5 rounded-2xl font-bold hover:bg-slate-700 transition active:scale-95 shadow-xl">Acesso Médico</button>
                <button onclick="entrar('secretaria')" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold hover:bg-blue-700 transition active:scale-95 shadow-xl shadow-blue-100">Acesso Secretaria</button>
            </div>
            <p class="mt-8 text-[10px] text-slate-300 font-bold uppercase tracking-widest">Sistema Pronto</p>
        </div>
    </div>

    <div id="app-content" class="hidden flex flex-col h-full">
        <header class="h-16 bg-white border-b px-8 flex items-center justify-between shrink-0 z-30">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-xl font-black">CH</div>
                <h1 class="font-bold text-slate-700 tracking-tight uppercase text-sm">Clinic Hero | <span id="label-perfil" class="text-blue-500">Módulo</span></h1>
            </div>
            <button onclick="location.reload()" class="text-slate-300 hover:text-red-500 transition"><i data-lucide="power"></i></button>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <aside class="w-64 bg-white border-r p-6 flex flex-col gap-2 shrink-0" id="sidebar">
                </aside>

            <main class="flex-1 p-10 overflow-y-auto" id="main-view">
                </main>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO SUPABASE
        const SB_URL = "https://ptcntqkmeypufwjrknyt.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0Y250cWttZXlwdWZ3anJrbnl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1Mzg3NjAsImV4cCI6MjA4MzExNDc2MH0.GPK2aNE9LYBBLVzFq7SVldhE0rzkXI3teYfwwh7TMtk";
        
        let supabase = null;

        // Inicializa o banco SEM bloquear a tela
        try {
            if(window.supabase) {
                supabase = window.supabase.createClient(SB_URL, SB_KEY);
            }
        } catch(e) { console.error("Erro Supabase", e); }

        // FUNÇÃO DE ENTRADA (NÃO DEPENDE DO BANCO)
        function entrar(role) {
            // 1. Some com o login
            document.getElementById('login-screen').classList.add('hidden');
            // 2. Mostra o app
            document.getElementById('app-content').classList.remove('hidden');
            // 3. Configura a tela
            document.getElementById('label-perfil').innerText = role === 'medico' ? 'Doutor' : 'Secretaria';
            
            renderSidebar(role);

            if(role === 'medico') {
                renderMedicoHome();
            } else {
                renderSecretariaHome();
            }
            lucide.createIcons();
        }

        function renderSidebar(role) {
            const side = document.getElementById('sidebar');
            if(role === 'medico') {
                side.innerHTML = `
                    <button onclick="renderMedicoHome()" class="flex items-center gap-3 p-4 w-full rounded-2xl bg-blue-50 text-blue-600 font-bold"><i data-lucide="list"></i> Atendimentos</button>
                    <button class="flex items-center gap-3 p-4 w-full text-slate-400 font-medium"><i data-lucide="calendar"></i> Agenda</button>
                `;
            } else {
                side.innerHTML = `
                    <button onclick="renderSecretariaHome()" class="flex items-center gap-3 p-4 w-full rounded-2xl bg-blue-600 text-white font-bold mb-2 shadow-lg shadow-blue-100"><i data-lucide="plus-circle"></i> Novo Cadastro</button>
                    <button onclick="listarPacientesSecretaria()" class="flex items-center gap-3 p-4 w-full text-slate-400 font-medium hover:bg-slate-50 rounded-xl transition"><i data-lucide="users"></i> Pacientes</button>
                `;
            }
        }

        // --- TELAS ---

        function renderSecretariaHome() {
            document.getElementById('main-view').innerHTML = `
                <div class="max-w-md mx-auto bg-white p-10 rounded-[40px] shadow-sm border border-slate-100 mt-10 fade-in">
                    <h2 class="text-2xl font-black mb-8">Novo Paciente</h2>
                    <div class="space-y-4">
                        <input id="f-nome" placeholder="Nome da Criança" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-700">
                        <label class="block text-xs font-bold text-slate-400 ml-2">DATA DE NASCIMENTO</label>
                        <input id="f-nasc" type="date" class="w-full p-4 bg-slate-50 rounded-2xl border-none outline-none font-bold text-slate-500">
                        <button onclick="salvarPaciente()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black shadow-lg shadow-blue-100 mt-4 active:scale-95 transition">CADASTRAR</button>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        async function salvarPaciente() {
            const nome = document.getElementById('f-nome').value;
            const nasc = document.getElementById('f-nasc').value;

            if(!supabase) return alert("Erro: Biblioteca Supabase não carregou.");
            if(!nome) return alert("Preencha o nome!");

            const { error } = await supabase.from('pacientes').insert([{ nome, data_nascimento: nasc }]);
            if (error) alert("Erro Supabase: " + error.message); 
            else { alert("Paciente salvo com sucesso!"); renderSecretariaHome(); }
        }

        async function renderMedicoHome() {
            const main = document.getElementById('main-view');
            main.innerHTML = `<p class="animate-pulse font-bold text-blue-600">Buscando dados...</p>`;
            
            if(!supabase) {
                 main.innerHTML = "Erro de conexão com banco de dados.";
                 return;
            }

            const { data, error } = await supabase.from('pacientes').select('*').order('criado_em', { ascending: false });
            
            if(error) {
                main.innerHTML = "Erro ao buscar pacientes: " + error.message;
                return;
            }

            main.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-3xl font-black mb-8">Fila de Atendimento</h2>
                    <div class="grid gap-4">
                        ${data.map(p => `
                            <div onclick="abrirProntuario('${p.id}', '${p.nome}', '${p.data_nascimento}')" class="bg-white p-6 rounded-[24px] border border-slate-100 hover:border-blue-500 transition cursor-pointer flex justify-between items-center group shadow-sm">
                                <div><h4 class="font-bold text-lg text-slate-800">${p.nome}</h4><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Nasc: ${p.data_nascimento || '---'}</p></div>
                                <span class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black">ATENDER →</span>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function abrirProntuario(id, nome, nascimento) {
            const main = document.getElementById('main-view');
            const nasc = new Date(nascimento);
            const hoje = new Date();
            let mesesIdade = (hoje.getFullYear() - nasc.getFullYear()) * 12 + (hoje.getMonth() - nasc.getMonth());
            if (hoje.getDate() < nasc.getDate()) mesesIdade--; // Ajuste de dia
            
            if(isNaN(mesesIdade)) mesesIdade = "?";

            main.innerHTML = `
                <div class="max-w-5xl mx-auto fade-in">
                    <div class="flex justify-between items-end mb-10">
                        <div><span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter">Idade: ${mesesIdade} meses</span>
                        <h2 class="text-4xl font-black text-slate-800 mt-2">${nome}</h2></div>
                        <button onclick="renderMedicoHome()" class="text-slate-400 font-bold hover:text-blue-600">Voltar</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-[30px] border shadow-sm grid grid-cols-3 gap-6">
                                <div class="text-center"><p class="text-[10px] font-black text-slate-400 uppercase mb-2">Peso (kg)</p><input id="p-peso" type="number" step="0.001" class="input-ped w-full"></div>
                                <div class="text-center"><p class="text-[10px] font-black text-slate-400 uppercase mb-2">Altura (cm)</p><input id="p-alt" type="number" class="input-ped w-full"></div>
                                <div class="text-center"><p class="text-[10px] font-black text-slate-400 uppercase mb-2">P. Cefálico</p><input id="p-pc" type="number" class="input-ped w-full"></div>
                            </div>
                            <div class="bg-white p-6 rounded-[30px] border shadow-sm">
                                <h4 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="edit-3" class="w-4 h-4 text-blue-500"></i> Evolução</h4>
                                <textarea id="p-evo" class="w-full h-80 bg-slate-50 rounded-2xl p-6 outline-none text-slate-600 border-none resize-none" placeholder="Evolução..."></textarea>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-slate-900 text-white p-8 rounded-[40px] shadow-2xl">
                                <button onclick="finalizarConsulta('${id}', '${mesesIdade}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-5 rounded-2xl font-black transition">FINALIZAR CONSULTA</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        async function finalizarConsulta(paciente_id, idadeMeses) {
            const peso = document.getElementById('p-peso').value;
            const altura = document.getElementById('p-alt').value;
            const pc = document.getElementById('p-pc').value;
            const evo = document.getElementById('p-evo').value;

            const { error } = await supabase.from('consultas').insert([{ paciente_id, peso, altura, perimetro_cefalico: pc, evolucao: evo, idade_na_consulta: idadeMeses + " meses" }]);
            if (error) alert("Erro: " + error.message); else { alert("Salvo!"); renderMedicoHome(); }
        }

        async function listarPacientesSecretaria() {
            const main = document.getElementById('main-view');
            const { data, error } = await supabase.from('pacientes').select('*').order('criado_em', { ascending: false });
            if(error) return alert("Erro: " + error.message);
            
            main.innerHTML = `<h2 class="text-2xl font-black mb-6">Lista de Pacientes</h2>` + 
                data.map(p => `<div class="p-4 bg-white border rounded-2xl mb-2 font-bold shadow-sm text-slate-700">${p.nome}</div>`).join('');
        }

        lucide.createIcons();
    </script>
</body>
</html>
